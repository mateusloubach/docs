name: ci

on:
  push:
    branches:
      - master
      - main
    paths:
      - "documentation/**"
  pull_request:
    branches:
      - master
      - main
    paths:
      - "documentation/**"

concurrency:
  group: ci-deploy
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    # every `run:` below is executed from ./documentation
    defaults:
      run:
        working-directory: documentation

    steps:
      # â€”â€”â€”â€”â€” Fullâ€‘depth checkout (history + tags) â€”â€”â€”â€”â€”
      - name: FULLâ€‘DEPTH CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # â€”â€”â€”â€”â€” Configure Git credentials â€”â€”â€”â€”â€”
      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      # â€”â€”â€”â€”â€” Set up Python & install deps â€”â€”â€”â€”â€”
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install MkDocsâ€‘Material & Mike
        run: pip install mkdocs-material mike

      # â€”â€”â€”â€”â€” Generate a weekly cache key â€”â€”â€”â€”â€”
      - name: Generate cache ID
        run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      # â€”â€”â€”â€”â€” Cache MkDocs theme files â€”â€”â€”â€”â€”
      - name: Cache mkdocs-material
        uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      # â€”â€”â€”â€”â€” Detect if ghâ€‘pages branch exists â€”â€”â€”â€”â€”
      - name: Check for existing gh-pages branch
        id: check-gh
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            echo "EXISTS=true" >> $GITHUB_ENV
          else
            echo "EXISTS=false" >> $GITHUB_ENV
          fi

      # â€”â€”â€”â€”â€” Capture current commit SHA & inject into docs â€”â€”â€”â€”â€”
      - name: Get commit SHA
        run: echo "SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Inject SHA into docs
        run: |
          sed -i "s/BUILD_SHA_HERE/${SHA}/g" docs/index.md

      # â€”â€”â€”â€”â€” Firstâ€‘time deploy: initialize ghâ€‘pages â€”â€”â€”â€”â€”
      - name: Initial MkDocs Deploy (branch init)
        if: env.EXISTS == 'false'
        run: mkdocs gh-deploy --force

      - name: Done (firstâ€‘time only)
        if: env.EXISTS == 'false'
        run: echo "gh-pages created; next docs change will version with Mike."

      # â€”â€”â€”â€”â€” Count docsâ€‘only commits ever â€”â€”â€”â€”â€”
      - name: Count docs commits
        if: env.EXISTS == 'true'
        id: count
        run: |
          COUNT=$(git log --pretty=format:"%h" -- documentation/ | wc -l | tr -d ' ')
          echo "COUNT=$COUNT" >> $GITHUB_ENV

      # â€”â€”â€”â€”â€” Compute version identifiers â€”â€”â€”â€”â€”
      - name: Determine version from tags
        if: env.EXISTS == 'true'
        run: |
          # Get the latest tag that matches semantic versioning
          LATEST_TAG=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Extract version numbers
          MAJOR=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\1/')
          MINOR=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\2/')
          PATCH=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\).*/\3/')

          # Check if there are new commits since the last tag
          COMMITS_SINCE=$(git rev-list ${LATEST_TAG}..HEAD --count 2>/dev/null || echo "1")

          if [ "$COMMITS_SINCE" -gt 0 ]; then
            # Increment patch version for new commits (bug fixes)
            PATCH=$((PATCH + 1))
          fi

          # Use clean semantic version without date suffix
          VERSION="v${MAJOR}.${MINOR}.${PATCH}"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_LABEL=$VERSION" >> $GITHUB_ENV

      # â€”â€”â€”â€”â€” Deploy docs with Mike using custom slug & title â€”â€”â€”â€”â€”
      - name: Deploy docs with Mike
        if: env.EXISTS == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mike deploy "${VERSION}" \
            --title "${VERSION_LABEL}" \
            --branch gh-pages --push
          mike set-default "${VERSION}" \
            --branch gh-pages --push

      # â€”â€”â€”â€”â€” Display GitHub Pages URLs â€”â€”â€”â€”â€”
      - name: Display GitHub Pages URLs
        if: env.EXISTS == 'true'
        run: |
          echo "ðŸ“„ GitHub Pages URLs:"
          echo "ðŸ”— Repository site: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ðŸ”— Current version: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${VERSION}/"
          echo "ðŸ”— Redirect target: https://${{ github.repository_owner }}.github.io/"
          echo "ðŸ“‹ Access your documentation at the repository site URL above"
          echo ""
          echo "ðŸ”„ Available versions:"
          mike list --branch gh-pages || echo "No versions found yet"

      # â€”â€”â€”â€”â€” Override root redirect to your homepage â€”â€”â€”â€”â€”
      - name: Override root redirect to homepage
        if: env.EXISTS == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = `https://${context.repo.owner}.github.io/`;
            const encoded = Buffer.from(`<!DOCTYPE html>
            <html>
              <head><meta http-equiv="refresh" content="0;url=${url}"></head>
              <body></body>
            </html>`).toString('base64');

            // Try to fetch existing file to get its SHA
            let sha;
            try {
              const { data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'index.html',
                ref: 'gh-pages'
              });
              sha = data.sha;
            } catch {}

            // Create or update the file
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'index.html',
              message: 'Override redirect to homepage',
              content: encoded,
              branch: 'gh-pages',
              sha
            });
